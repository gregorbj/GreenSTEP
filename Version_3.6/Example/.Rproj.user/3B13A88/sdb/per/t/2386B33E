{
    "collab_server" : "",
    "contents" : "#calc_summary_measures.r\n#Brian Gregor\n#12/18/2016\n\n#Purpose\n#-------\n#This script calculates a number of statewide and county level measures from one or more GreenSTEP scenarios.  The results are put into a table that is saved as a CSV formatted text file where the rows correspond to measures and the columns correspond to scenarios and years.  The statewide measures to be calculated are specified in a text file whose format is described below.  This enables the output measures to be revised without revising the code in this script.  New measures can be added as long as the data needed to calculate the measures is contained in the standard objects saved as part of a GreenSTEP run.  Standard R expressions are used to specify the calculations.  In a similar fashion, an input file specifies the calculation of county-level measures.  However, because counties add another dimension to the table, the results are flattened out in the final output table so that the rows correspond to the combination of a measure and county.\n\n#Revisions\n#---------\n#2/4/2016: The \"calcAreaMeasures\" function was revised to enable the specification of temporary variable. These variables are calculated and added to the \"Summary_\" list just like any other performance measures. However, they are removed from list before the area performance measure table is created. The names of temporary variables must be prefixed by \"Temp_\", \"temp_\", or \"TEMP_\".\n#12/18/2016: Script modified to work with the GreenSTEP model\n\n#Define function to calculate the areawide summary measures for a scenario\n#-------------------------------------------------------------------------\n#Function Name:\n#calcAreaMeasures\n#Function Arguments:\n#ScenarioPath - Path name of the directory for the scenario to be analyzed\n#Year - Year to summarize\n#CalcSpecFile - The path name of a text file in comma separated values format containing the specifications of the measures, calculations to be completed, and units of the measure.  Each line has 3 entries.  The first line of the file is the header and has the following entries: Measure, Calculation, Units.  Each successive line has entries for the name of the measure, the formula for calculating the measure from GreenSTEP inputs and outputs that are contained in any of three R objects stored in the GreenSTEP_ outputs directory for a scenario and year, and documentation of the units of the measure.\n#Function Return Value:\n#The function returns a named list.  The first component of the list (Measures) is a named vector containing the values computed for each measure.  The names are the measure names.  The second component of the list (Units) is a named vector containing the units descriptions of each measure.  The names are the measure names.\n\ncalcStateMeasures <- function(Year) {\n  # Load the data\n  Path <- paste0(\"scenario\", \"/outputs/\", \"Year\", Year)\n  Objs. <-\n    c(\"Hh_\", \"CommServ_\", \"Metropolitan_\", \"Model_\", \"Inputs_\")\n  Files. <- paste(Objs., \".RData\", sep = \"\")\n  for (File in Files.) {\n    load(paste(Path, File, sep = \"/\"))\n  }\n  \n  # Attach the data\n  attach(Hh_)\n  attach(CommServ_)\n  attach(Metropolitan_)\n  attach(Model_)\n  attach(Inputs_)\n  \n  # Load the measures calculation specification\n  CalcSpecs.. <-\n    read.csv(\"scripts/state_measures_spec.csv\", as.is = TRUE)\n  \n  # Iterate through specifications and do the calculations\n  Summary_ <- list()\n  for (i in 1:nrow(CalcSpecs..)) {\n    MeasureName <- CalcSpecs..[i, \"Measure\"]\n    CalcSpec <- CalcSpecs..[i, \"Calculation\"]\n    Summary_[[MeasureName]] <- try(eval(parse(text = CalcSpec)))\n  }\n  \n  # Remove temporary measures\n  #i.e. measures whose names start with Temp_, temp_, or TEMP_\n  MeasureNames_ <- strsplit(names(Summary_), \"_\")\n  IsTempMeasure. <- unlist(lapply(MeasureNames_, function(x) {\n    x[1] %in% c(\"Temp\", \"temp\", \"TEMP\")\n  }))\n  Summary_ <- Summary_[!IsTempMeasure.]\n  \n  # Make into vector and clean out superfluous names\n  Summary. <- sapply(Summary_, function(x) {\n    Y <- x\n    names(Y) <- NULL\n    Y\n  })\n  \n  # Make a named vector of the units\n  Units. <- CalcSpecs..$Units[!IsTempMeasure.]\n  names(Units.) <- CalcSpecs..$Measure[!IsTempMeasure.]\n  \n  # Function exit procedure\n  on.exit(detach(Hh_))\n  on.exit(detach(CommServ_), add = TRUE)\n  on.exit(detach(Metropolitan_), add = TRUE)\n  on.exit(detach(Model_), add = TRUE)\n  on.exit(detach(Inputs_), add = TRUE)\n  \n  # Return the results\n  list(Measures = Summary., Units = Units.)\n}\n\n\n#Define function to calculate the county summary measures for a scenario\n#-----------------------------------------------------------------------\n#Function Name:\n#calcCountyMeasures\n#Function Arguments:\n#ScenarioPath - Path name of the directory for the scenario to be analyzed\n#Year - Year to summarize\n#CalcSpecFile - The path name of a text file in comma separated values format containing the specifications of the measures, calculations to be completed, and units of the measure.  Each line has 3 entries.  The first line of the file is the header and has the following entries: Measure, Calculation, Units.  Each successive line has entries for the name of the measure, the formula for calculating the measure from GreenSTEP inputs and outputs that are contained in any of three R objects stored in the RSPM outputs directory for a scenario and year, and documentation of the units of the measure.\n#Function Return Value:\n#The function returns a named list.  The first component of the list (Measures) is a named vector containing the values computed for each measure and district.  The names are a concatenation of the measure and district names (measure.district).  The second component of the list (Units) is a named vector containing the units descriptions of each measure.  The names are a concatenation of the measure and district names (measure.district).\n\ncalcCountyMeasures <- function(Year) {\n  # Load the data\n  Path <- paste0(\"scenario\", \"/outputs/\", \"Year\", Year)\n  Objs. <-\n    c(\"Hh_\", \"CommServ_\", \"Metropolitan_\", \"Model_\", \"Inputs_\")\n  Files. <- paste(Objs., \".RData\", sep = \"\")\n  for (File in Files.) {\n    load(paste(Path, File, sep = \"/\"))\n  }\n  \n  # Attach the data\n  attach(Hh_)\n  attach(CommServ_)\n  attach(Metropolitan_)\n  attach(Model_)\n  attach(Inputs_)\n  \n  # Load the measures calculation specification\n  CalcSpecs.. <-\n    read.csv(\"scripts/county_measures_spec.csv\", as.is = TRUE)\n  \n  # Determine the number of districts\n  Counties <- rownames(Model_$CountyGroups..)\n  \n  # Iterate through specifications and do the calculations\n  Summary_ <- list()\n  for (i in 1:nrow(CalcSpecs..)) {\n    MeasureName <- CalcSpecs..[i, \"Measure\"]\n    CalcSpec <- CalcSpecs..[i, \"Calculation\"]\n    Measure.Co <- eval(parse(text = CalcSpec))\n    if (!all(names(Measure.Co) %in% Counties)) {\n      ErrMsg <-\n        paste(\"Result for measure\",\n              MeasureName,\n              \"does not correspond to counties\")\n      stop(ErrMsg)\n    }\n    Summary_[[MeasureName]] <- Measure.Co\n  }\n  \n  # Make into vector concatenating measure and district names\n  Summary. <- unlist(Summary_)\n  \n  # Make a named vector of the units\n  Units. <- rep(CalcSpecs..$Units, each = length(Counties))\n  names(Units.) <- names(Summary.)\n  \n  # Function exit procedure\n  on.exit(detach(Hh_))\n  on.exit(detach(CommServ_), add = TRUE)\n  on.exit(detach(Metropolitan_), add = TRUE)\n  on.exit(detach(Model_), add = TRUE)\n  on.exit(detach(Inputs_), add = TRUE)\n  \n  # Return the results\n  list(Measures = Summary., Units = Units.)\n}\n\n\n#Iterate through run years and calculate summary measures\n#========================================================\nlocal({\n  StateResults_ <- list()\n  CountyResults_ <- list()\n  #Calculate summary measures for all years\n  for (yr in RunYears) {\n    StateResults_[[yr]] <- calcStateMeasures(yr)\n    CountyResults_[[yr]] <- calcCountyMeasures(yr)\n  }\n  #Prepare and save State measures table\n  StateResults.. <-\n    data.frame(list(Measure = names(StateResults_[[1]]$Measures)))\n  StateResults.. <-\n    cbind(StateResults.., do.call(cbind, lapply(StateResults_, function(x)\n      x$Measures)))\n  StateResults..$Units <- StateResults_[[1]]$Units\n  write.table(\n    StateResults..,\n    file = \"scenario/outputs/summary_state_measures.csv\",\n    col.names = TRUE,\n    row.names = FALSE,\n    sep = \",\"\n  )\n  #Prepare and save County measures table\n  CountyResults.. <-\n    data.frame(list(Measure = names(CountyResults_[[1]]$Measures)))\n  CountyResults.. <-\n    cbind(CountyResults.., do.call(cbind, lapply(CountyResults_, function(x)\n      x$Measures)))\n  CountyResults..$Units <- CountyResults_[[1]]$Units\n  write.table(\n    CountyResults..,\n    file = \"scenario/outputs/summary_county_measures.csv\",\n    col.names = TRUE,\n    row.names = FALSE,\n    sep = \",\"\n  )\n})\n",
    "created" : 1482073355688.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "750112150",
    "id" : "2386B33E",
    "lastKnownWriteTime" : 1482081581,
    "last_content_update" : 1482081581814,
    "path" : "~/GitHub/GreenSTEP/Version_3.6/Example/scripts/calc_summary_measures.r",
    "project_path" : "scripts/calc_summary_measures.r",
    "properties" : {
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}